<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>Mini Kahoot</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body { font-family:sans-serif; background:#f3f4f6; text-align:center; }
.card { background:#fff; padding:20px; margin:20px auto; border-radius:14px; max-width:420px; }
button { width:100%; padding:14px; margin:6px 0; font-size:18px; border:none; border-radius:10px; background:#4f46e5; color:white; }
button:disabled { background:#9ca3af; }
input { width:100%; padding:12px; font-size:16px; }
.choice { background:#6366f1; }
.timer { font-size:22px; font-weight:bold; color:#dc2626; }
</style>
</head>
<body>

<h1>üéÆ Mini Kahoot</h1>

<div class="card" id="home">
  <button onclick="createRoom()">üé§ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á (Host)</button>
  <hr>
  <input id="pinInput" placeholder="PIN ‡∏´‡πâ‡∏≠‡∏á">
  <input id="nameInput" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô">
  <button onclick="joinRoom()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°</button>
</div>

<div class="card" id="host" style="display:none;">
  <h2>HOST</h2>
  <p>PIN: <b id="roomPin"></b></p>
  <button onclick="nextQuestion()">‚ñ∂ ‡πÄ‡∏£‡∏¥‡πà‡∏° / ‡∏Ç‡πâ‡∏≠‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
</div>

<div class="card" id="game" style="display:none;">
  <h2 id="question">‡∏£‡∏≠ Host ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°</h2>
  <div class="timer" id="timer"></div>
  <div id="choices"></div>
</div>

<div class="card">
  <h2>üèÜ Leaderboard</h2>
  <ul id="scores"></ul>
</div>

<script>
// ================= Firebase =================
firebase.initializeApp({
  apiKey: "AIzaSyCWZRDRx0SYNivY2BIsepJZxwjkYKtnKms",
  authDomain: "game-6fda9.firebaseapp.com",
  databaseURL: "https://game-6fda9-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "game-6fda9"
});
const db = firebase.database();

// ================= Questions =================
const questions = [
  { text:"205 + 330 = ?", choices:["500","520","535","550"], answer:1 },
  { text:"100 √ó 5 = ?", choices:["200","300","500","1000"], answer:2 },
  { text:"900 √∑ 3 = ?", choices:["200","300","400","500"], answer:1 }
];

// ================= State =================
let room = "";
let playerId = Math.random().toString(36).substr(2,9);
let isHost = false;
let answered = false;
let currentTimer = 0;
let currentQIndex = -1;

// ================= Create Room =================
function createRoom(){
  room = Math.floor(100000 + Math.random()*900000).toString();
  isHost = true;

  document.getElementById("home").style.display="none";
  document.getElementById("host").style.display="block";
  document.getElementById("game").style.display="block";
  document.getElementById("roomPin").innerText = room;

  db.ref(room).set({
    qIndex: -1,
    timer: 0,
    players: {}
  });

  listenRoom();
}

// ================= Join Room =================
function joinRoom(){
  room = document.getElementById("pinInput").value.trim();
  const name = document.getElementById("nameInput").value.trim();
  if(!room || !name) return alert("‡∏Å‡∏£‡∏≠‡∏Å PIN ‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠");

  db.ref(room + "/players/" + playerId).set({
    name:name,
    score:0
  });

  document.getElementById("home").style.display="none";
  document.getElementById("game").style.display="block";

  listenRoom();
}

// ================= Listen Room =================
function listenRoom(){
  db.ref(room).on("value", snap=>{
    const data = snap.val();
    if(!data) return;

    currentTimer = data.timer || 0;
    currentQIndex = data.qIndex;

    const q = questions[currentQIndex];
    if(!q){
      document.getElementById("question").innerText = "‡∏£‡∏≠ Host ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°";
      document.getElementById("choices").innerHTML = "";
      return;
    }

    answered = false;
    document.getElementById("question").innerText = q.text;
    document.getElementById("timer").innerText = "‚è± " + currentTimer;

    const div = document.getElementById("choices");
    div.innerHTML = "";

    q.choices.forEach((c,i)=>{
      const btn = document.createElement("button");
      btn.className = "choice";
      btn.innerText = c;
      btn.onclick = () => submitAnswer(i);
      div.appendChild(btn);
    });
  });
}

// ================= Next Question (Host) =================
function nextQuestion(){
  db.ref(room + "/qIndex").transaction(i => (i ?? -1) + 1);
  db.ref(room + "/timer").set(10);
}

// ================= Submit Answer =================
function submitAnswer(choice){
  if(answered || currentQIndex < 0) return;
  answered = true;

  const correct = questions[currentQIndex].answer;

  if(choice === correct){
    db.ref(room + "/players/" + playerId + "/score")
      .transaction(score => (score || 0) + currentTimer);
  }
}

// ================= Timer (Host only) =================
setInterval(()=>{
  if(!isHost || !room) return;
  db.ref(room + "/timer").transaction(t=>{
    if(t > 0) return t - 1;
    return t;
  });
},1000);

// ================= Leaderboard =================
db.ref().on("value", snap=>{
  if(!room) return;
  const players = snap.child(room + "/players").val() || {};
  const ul = document.getElementById("scores");
  ul.innerHTML = "";

  Object.values(players)
    .sort((a,b)=>b.score-a.score)
    .forEach(p=>{
      const li = document.createElement("li");
      li.innerText = `${p.name}: ${p.score}`;
      ul.appendChild(li);
    });
});
</script>

</body>
</html>
