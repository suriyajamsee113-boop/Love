<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>Mini Kahoot</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body { font-family:sans-serif; background:#f3f4f6; text-align:center; }
.card { background:#fff; padding:20px; margin:20px auto; border-radius:14px; max-width:420px; }

button {
  width:100%;
  padding:14px;
  margin:6px 0;
  font-size:18px;
  border:none;
  border-radius:10px;
  background:#4f46e5;
  color:white;
  transition: transform 0.12s ease;
}
button:active { transform: scale(0.94); }
button:disabled { background:#9ca3af; }

input { width:100%; padding:12px; font-size:16px; }

.choice { background:#6366f1; }
.correct { background:#16a34a !important; }
.wrong { background:#dc2626 !important; }

.timer { font-size:22px; font-weight:bold; color:#dc2626; }
.muted { color:#6b7280; font-size:18px; }
</style>
</head>
<body>

<h1>üéÆ Mini Kahoot</h1>

<div class="card" id="home">
  <button onclick="createRoom()">üé§ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á (Host)</button>
  <hr>
  <input id="pinInput" placeholder="PIN ‡∏´‡πâ‡∏≠‡∏á">
  <input id="nameInput" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô">
  <button onclick="joinRoom()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°</button>
</div>

<div class="card" id="host" style="display:none;">
  <h2>HOST</h2>
  <p>PIN: <b id="roomPin"></b></p>
  <button onclick="nextQuestion()">‚ñ∂ ‡∏Ç‡πâ‡∏≠‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
  <button onclick="resetGame()" style="background:#dc2626;">üîÑ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏Å‡∏°</button>
</div>

<div class="card" id="game" style="display:none;">
  <h2 id="question">‡∏£‡∏≠ Host ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°</h2>
  <div class="timer" id="timer"></div>
  <div id="choices"></div>
</div>

<div class="card">
  <h2>üèÜ Leaderboard</h2>
  <ul id="scores"></ul>
</div>

<script>
// ================= Firebase =================
firebase.initializeApp({
  apiKey: "AIzaSyCWZRDRx0SYNivY2BIsepJZxwjkYKtnKms",
  authDomain: "game-6fda9.firebaseapp.com",
  databaseURL: "https://game-6fda9-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "game-6fda9"
});
const db = firebase.database();

// ================= Questions =================
const questions = [
  { text:"205 + 330 = ?", choices:["500","520","535","550"], answer:1 },
  { text:"100 √ó 5 = ?", choices:["200","300","500","1000"], answer:2 },
  { text:"900 √∑ 3 = ?", choices:["200","300","400","500"], answer:1 }
];

// ================= State =================
let room = "";
let playerId = Math.random().toString(36).substr(2,9);
let isHost = false;

// ================= Create / Join =================
function createRoom(){
  room = Math.floor(100000 + Math.random()*900000).toString();
  isHost = true;

  home.style.display="none";
  host.style.display="block";
  game.style.display="block";
  roomPin.innerText = room;

  resetDB();
  listenRoom();
}

function joinRoom(){
  room = pinInput.value.trim();
  const name = nameInput.value.trim();
  if(!room || !name) return alert("‡∏Å‡∏£‡∏≠‡∏Å PIN ‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠");

  db.ref(room+"/players/"+playerId).set({
    name:name,
    score:0
  });

  home.style.display="none";
  game.style.display="block";

  listenRoom();
}

// ================= Reset =================
function resetDB(){
  db.ref(room).set({
    qIndex:-1,
    timer:0,
    reveal:false,
    answeredPlayers:{},
    players:{}
  });
}

function resetGame(){
  if(confirm("‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏Å‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?")){
    resetDB();
  }
}

// ================= Listen Room =================
function listenRoom(){
  db.ref(room).on("value", snap=>{
    const data = snap.val();
    if(!data) return;

    const qIndex = data.qIndex;
    const timer = data.timer;
    const reveal = data.reveal;
    const answeredPlayers = data.answeredPlayers || {};

    timer && (document.getElementById("timer").innerText = "‚è± "+timer);
    if(timer === 0) document.getElementById("timer").innerText = "";

    const q = questions[qIndex];
    choices.innerHTML = "";

    if(!q){
      question.innerText = "‡∏£‡∏≠ Host ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°";
      return;
    }

    question.innerText = q.text;

    // üõë ‡∏ñ‡πâ‡∏≤‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡∏ï‡∏≠‡∏ö‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏Ç‡πâ‡∏≠‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
    if(answeredPlayers[playerId]){
      choices.innerHTML = "<p class='muted'>‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‚è≥</p>";
      return;
    }

    // ‚õî ‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤
    if(timer <= 0 && !reveal){
      choices.innerHTML = "<p class='muted'>‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤ ‚åõ</p>";
      return;
    }

    // ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
    q.choices.forEach((c,i)=>{
      const btn = document.createElement("button");
      btn.className = "choice";
      btn.innerText = c;
      btn.onclick = () => submitAnswer(i);
      choices.appendChild(btn);
    });
  });
}

// ================= Submit Answer =================
function submitAnswer(choice){
  // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡πà‡∏≤‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡∏ï‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß (‡∏•‡πá‡∏≠‡∏Å‡∏ñ‡∏≤‡∏ß‡∏£)
  db.ref(room+"/answeredPlayers/"+playerId).set(true);

  // ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ñ‡πâ‡∏≤‡∏ñ‡∏π‡∏Å
  db.ref(room).once("value").then(snap=>{
    const data = snap.val();
    const q = questions[data.qIndex];
    if(choice === q.answer){
      db.ref(room+"/players/"+playerId+"/score")
        .transaction(s => (s||0) + data.timer);
    }
  });
}

// ================= Host Controls =================
function nextQuestion(){
  db.ref(room+"/qIndex").transaction(i=>(i??-1)+1);
  db.ref(room+"/timer").set(10);
  db.ref(room+"/reveal").set(false);
  db.ref(room+"/answeredPlayers").set({});
}

// Timer (Host only)
setInterval(()=>{
  if(!isHost || !room) return;
  db.ref(room+"/timer").transaction(t=>{
    if(t > 0) return t - 1;
    if(t === 0) db.ref(room+"/reveal").set(true);
    return t;
  });
},1000);

// ================= Leaderboard =================
db.ref().on("value", snap=>{
  if(!room) return;
  const players = snap.child(room+"/players").val()||{};
  scores.innerHTML="";
  Object.values(players)
    .sort((a,b)=>b.score-a.score)
    .forEach(p=>{
      const li=document.createElement("li");
      li.innerText=`${p.name}: ${p.score}`;
      scores.appendChild(li);
    });
});
</script>

</body>
</html>
