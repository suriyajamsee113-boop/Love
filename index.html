<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Math Quiz Party</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap');
    body { font-family: 'Kanit', sans-serif; }
  </style>
</head>

<body class="bg-indigo-900 min-h-screen flex items-center justify-center p-4">

<div id="app" class="w-full max-w-md bg-white rounded-2xl shadow-2xl p-6">

  <!-- HOME -->
  <div id="screen-home" class="text-center">
    <h1 class="text-3xl font-bold text-indigo-600 mb-4">Math Quiz Party üéÆ</h1>

    <button id="btn-host"
      class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl mb-4">
      ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á (‡πÇ‡∏Æ‡∏™‡∏ï‡πå)
    </button>

    <input id="join-id"
      class="w-full border border-gray-300 rounded-xl px-4 py-3 mb-3 text-center uppercase"
      placeholder="‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á">

    <button id="btn-join"
      class="w-full bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-3 rounded-xl">
      ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡πÄ‡∏Å‡∏°
    </button>
  </div>

  <!-- NAME -->
  <div id="screen-name" class="hidden text-center">
    <h2 class="text-xl font-bold mb-3">‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h2>
    <input id="player-name"
      class="w-full border border-gray-300 rounded-xl px-4 py-3 mb-3 text-center">
    <button id="btn-enter"
      class="w-full bg-indigo-600 text-white font-bold py-3 rounded-xl">
      ‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á
    </button>
  </div>

  <!-- LOBBY -->
  <div id="screen-lobby" class="hidden">
    <h2 class="text-center font-bold mb-3">
      ‡∏´‡πâ‡∏≠‡∏á: <span id="room-id" class="text-pink-500"></span>
    </h2>

    <ul id="player-list" class="mb-4 space-y-1"></ul>

    <button id="btn-start"
      class="hidden w-full bg-emerald-500 text-white font-bold py-3 rounded-xl">
      ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°
    </button>
  </div>

  <!-- QUIZ -->
  <div id="screen-quiz" class="hidden text-center">
    <h2 id="question" class="text-xl font-bold mb-4"></h2>
    <div id="choices" class="space-y-3"></div>
  </div>

  <!-- RESULT -->
  <div id="screen-result" class="hidden">
    <h2 class="text-xl font-bold text-center mb-4">‡∏ú‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h2>
    <ul id="score-list" class="space-y-2"></ul>
    <button onclick="location.reload()"
      class="mt-4 w-full bg-gray-200 py-3 rounded-xl font-bold">
      ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å
    </button>
  </div>

</div>

<script>
/* ================= FIREBASE SETUP ================= */
const firebaseConfig = {
  apiKey: "AIzaSyCwZRDRx0SYNivY2BIsepJZxwjKYkTnKms",
  authDomain: "game-6fda9.firebaseapp.com",
  projectId: "game-6fda9",
  storageBucket: "game-6fda9.firebasestorage.app",
  messagingSenderId: "121486223888",
  appId: "1:121486223888:web:10f81ae5f492e80d31b895"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

/* ================= STATE ================= */
let uid = "";
let room = "";
let name = "";
let isHost = false;
let score = 0;

/* ================= QUESTIONS ================= */
const QUESTIONS = [
  { q: "205 + 330 = ?", c: ["535","525","545","635"], a: 0 },
  { q: "12 √ó 12 = ?", c: ["124","144","164","142"], a: 1 },
  { q: "50% ‡∏Ç‡∏≠‡∏á 1000 = ?", c: ["250","400","500","600"], a: 2 }
];

/* ================= INIT ================= */
async function init() {
  await auth.signInAnonymously();
  uid = auth.currentUser.uid;
}
init();

/* ================= HELPERS ================= */
function show(id) {
  document.querySelectorAll("#app > div").forEach(d => d.classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
}

/* ================= ELEMENTS ================= */
const btnHost   = document.getElementById("btn-host");
const btnJoin   = document.getElementById("btn-join");
const btnEnter  = document.getElementById("btn-enter");
const btnStart  = document.getElementById("btn-start");

/* ================= HOST ================= */
btnHost.onclick = async () => {
  room = Math.random().toString(36).substring(2,8).toUpperCase();
  isHost = true;

  await db.doc(`rooms/${room}`).set({
    host: uid,
    q: -1,
    status: "waiting"
  });

  show("screen-name");
};

/* ================= JOIN ================= */
btnJoin.onclick = async () => {
  room = document.getElementById("join-id").value.toUpperCase();
  const snap = await db.doc(`rooms/${room}`).get();
  if (!snap.exists) return alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡πâ‡∏≠‡∏á");
  show("screen-name");
};

btnEnter.onclick = async () => {
  name = document.getElementById("player-name").value;
  await db.doc(`rooms/${room}/players/${uid}`).set({ name, score: 0 });

  document.getElementById("room-id").innerText = room;
  show("screen-lobby");
  if (isHost) btnStart.classList.remove("hidden");
  listen();
};

/* ================= LOBBY ================= */
function listen() {
  db.collection(`rooms/${room}/players`)
    .onSnapshot(snap => {
      document.getElementById("player-list").innerHTML =
        snap.docs.map(d => `<li>${d.data().name}</li>`).join("");
    });

  db.doc(`rooms/${room}`).onSnapshot(doc => {
    const d = doc.data();
    if (d.q >= 0) showQuestion(d.q);
    if (d.status === "done") showResult();
  });
}

btnStart.onclick = async () => {
  await db.doc(`rooms/${room}`).update({ q: 0 });
};

/* ================= QUIZ ================= */
function showQuestion(i) {
  show("screen-quiz");
  const q = QUESTIONS[i];
  document.getElementById("question").innerText = q.q;

  const box = document.getElementById("choices");
  box.innerHTML = "";

  q.c.forEach((txt, idx) => {
    const b = document.createElement("button");
    b.className = "w-full bg-indigo-500 text-white py-3 rounded-xl";
    b.innerText = txt;
    b.onclick = async () => {
      if (idx === q.a) score += 100;
      await db.doc(`rooms/${room}/players/${uid}`).update({ score });

      if (isHost) {
        if (i + 1 < QUESTIONS.length)
          await db.doc(`rooms/${room}`).update({ q: i + 1 });
        else
          await db.doc(`rooms/${room}`).update({ status: "done" });
      }
    };
    box.appendChild(b);
  });
}

/* ================= RESULT ================= */
async function showResult() {
  show("screen-result");
  const snap = await db.collection(`rooms/${room}/players`).get();
  document.getElementById("score-list").innerHTML =
    snap.docs.map(d => d.data())
      .sort((a,b)=>b.score-a.score)
      .map(p => `<li>${p.name} : ${p.score}</li>`).join("");
}
</script>

</body>
</html>
