<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Math Quiz Party</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase (compat for simple use) -->
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap');
    body { font-family: 'Kanit', sans-serif; }
  </style>
</head>

<body class="bg-indigo-900 text-white min-h-screen flex items-center justify-center p-4">

<div id="app" class="w-full max-w-md bg-white text-gray-800 rounded-2xl shadow-2xl p-6">

  <!-- HOME -->
  <div id="home" class="text-center">
    <h1 class="text-3xl font-bold text-indigo-600 mb-4">Math Quiz Party üéÆ</h1>
    <button id="btn-host" class="w-full bg-indigo-600 text-white py-3 rounded-xl mb-4">
      ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á (‡πÇ‡∏Æ‡∏™‡∏ï‡πå)
    </button>
    <input id="join-id" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á" class="w-full border p-3 rounded-xl mb-3 text-center uppercase">
    <button id="btn-join" class="w-full bg-emerald-500 text-white py-3 rounded-xl">
      ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡πÄ‡∏Å‡∏°
    </button>
  </div>

  <!-- NAME -->
  <div id="name-screen" class="hidden text-center">
    <h2 class="text-xl font-bold mb-3">‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h2>
    <input id="player-name" class="w-full border p-3 rounded-xl mb-3 text-center">
    <button id="btn-enter" class="w-full bg-indigo-600 text-white py-3 rounded-xl">
      ‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á
    </button>
  </div>

  <!-- LOBBY -->
  <div id="lobby" class="hidden">
    <h2 class="text-center font-bold mb-3">
      ‡∏´‡πâ‡∏≠‡∏á: <span id="room-id" class="text-pink-500"></span>
    </h2>
    <ul id="players" class="mb-4"></ul>
    <button id="btn-start" class="hidden w-full bg-emerald-500 text-white py-3 rounded-xl">
      ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°
    </button>
  </div>

  <!-- QUIZ -->
  <div id="quiz" class="hidden text-center">
    <h2 id="question" class="text-xl font-bold mb-4"></h2>
    <div id="choices" class="space-y-3"></div>
  </div>

  <!-- RESULT -->
  <div id="result" class="hidden">
    <h2 class="text-xl font-bold text-center mb-4">‡∏ú‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h2>
    <ul id="scores"></ul>
  </div>

</div>

<script>
/* ================= FIREBASE SETUP ================= */
const firebaseConfig = {
  apiKey: "AIzaSyCwZRDRx0SYNivY2BIsepJZxwjKYkTnKms",
  authDomain: "game-6fda9.firebaseapp.com",
  projectId: "game-6fda9",
  storageBucket: "game-6fda9.firebasestorage.app",
  messagingSenderId: "121486223888",
  appId: "1:121486223888:web:10f81ae5f492e80d31b895"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

let uid = "";
let room = "";
let name = "";
let isHost = false;
let score = 0;

const QUESTIONS = [
  { q: "205 + 330 = ?", c: ["535","525","545","635"], a: 0 },
  { q: "12 √ó 12 = ?", c: ["124","144","164","142"], a: 1 },
];

/* ================= INIT ================= */
async function init() {
  await auth.signInAnonymously();
  uid = auth.currentUser.uid;
}
init();

/* ================= HELPERS ================= */
function show(id) {
  document.querySelectorAll("#app > div").forEach(d => d.classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
}

/* ================= HOST ================= */
btn-host.onclick = async () => {
  room = Math.random().toString(36).substring(2,8).toUpperCase();
  isHost = true;

  await db.doc(`rooms/${room}`).set({
    host: uid,
    q: -1,
    status: "waiting"
  });

  show("name-screen");
};

/* ================= JOIN ================= */
btn-join.onclick = async () => {
  room = join-id.value.toUpperCase();
  const snap = await db.doc(`rooms/${room}`).get();
  if (!snap.exists) return alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡πâ‡∏≠‡∏á");
  show("name-screen");
};

btn-enter.onclick = async () => {
  name = player-name.value;
  await db.doc(`rooms/${room}/players/${uid}`).set({
    name, score: 0
  });

  room-id.innerText = room;
  show("lobby");
  if (isHost) btn-start.classList.remove("hidden");
  listen();
};

/* ================= LOBBY ================= */
function listen() {
  db.collection(`rooms/${room}/players`)
    .onSnapshot(snap => {
      players.innerHTML = snap.docs.map(d => `<li>${d.data().name}</li>`).join("");
    });

  db.doc(`rooms/${room}`).onSnapshot(doc => {
    const data = doc.data();
    if (data.q >= 0) showQuestion(data.q);
    if (data.status === "done") showResult();
  });
}

btn-start.onclick = async () => {
  await db.doc(`rooms/${room}`).update({ q: 0 });
};

/* ================= QUIZ ================= */
function showQuestion(i) {
  show("quiz");
  const q = QUESTIONS[i];
  question.innerText = q.q;
  choices.innerHTML = "";

  q.c.forEach((txt, idx) => {
    const b = document.createElement("button");
    b.className = "w-full bg-indigo-500 text-white py-3 rounded-xl";
    b.innerText = txt;
    b.onclick = async () => {
      if (idx === q.a) score += 100;
      await db.doc(`rooms/${room}/players/${uid}`).update({ score });
      if (isHost) {
        if (i + 1 < QUESTIONS.length)
          await db.doc(`rooms/${room}`).update({ q: i + 1 });
        else
          await db.doc(`rooms/${room}`).update({ status: "done" });
      }
    };
    choices.appendChild(b);
  });
}

/* ================= RESULT ================= */
async function showResult() {
  show("result");
  const snap = await db.collection(`rooms/${room}/players`).get();
  scores.innerHTML = snap.docs
    .map(d => d.data())
    .sort((a,b)=>b.score-a.score)
    .map(p => `<li>${p.name} : ${p.score}</li>`).join("");
}
</script>

</body>
</html>
